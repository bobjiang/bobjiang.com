<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Angular或Ionic 异常处理：ErrorHandler - DTeam 团队日志</title>
	<meta name="description" content="在前端异常处理是非常重要的，包括客户端和服务端的异常。之前异常处理是对于每个异步函数添加err处理，这样不仅加大了工作量，还容易遗漏某些异常。幸好Angular6提供了ErrorHandler来处理异常（Ionic4为IonicErrorHandler），默认的ErrorHandler处理异常是将其输出在console上，这显然不能满足需求，所以需要自己实现一个GlobalErrorHandler。" />
	<meta name="author" content="纪瑞瑶" />
	<link rel="icon" type="image/png" href=/images/favicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Angular或Ionic 异常处理：ErrorHandler" />
<meta property="og:description" content="在前端异常处理是非常重要的，包括客户端和服务端的异常。之前异常处理是对于每个异步函数添加err处理，这样不仅加大了工作量，还容易遗漏某些异常。幸好Angular6提供了ErrorHandler来处理异常（Ionic4为IonicErrorHandler），默认的ErrorHandler处理异常是将其输出在console上，这显然不能满足需求，所以需要自己实现一个GlobalErrorHandler。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.dteam.top/posts/2020-02/angular%E6%88%96ionic-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86errorhandler.html" />
<meta property="article:published_time" content="2020-02-06T16:05:38+08:00" />
<meta property="article:modified_time" content="2020-02-06T16:05:38+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Angular或Ionic 异常处理：ErrorHandler"/>
<meta name="twitter:description" content="在前端异常处理是非常重要的，包括客户端和服务端的异常。之前异常处理是对于每个异步函数添加err处理，这样不仅加大了工作量，还容易遗漏某些异常。幸好Angular6提供了ErrorHandler来处理异常（Ionic4为IonicErrorHandler），默认的ErrorHandler处理异常是将其输出在console上，这显然不能满足需求，所以需要自己实现一个GlobalErrorHandler。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300"
		rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://blog.dteam.top/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://blog.dteam.top/css/main.css" /><link rel="stylesheet" type="text/css" href="https://blog.dteam.top/css/dark.css"
		media="(prefers-color-scheme: dark)"  />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://blog.dteam.top/js/main.js"></script>
	
	<script type="application/ld+json">{
		  "@context": "http://schema.org",
		  "@type": "BlogPosting",
		  "headline": "Angular或Ionic 异常处理：ErrorHandler",
		  "genre": "",
		  "datePublished": "2020-02-06T08:05:38Z",
		  "dateModified": "2020-02-06T08:05:38Z",
		  "description": "在前端异常处理是非常重要的，包括客户端和服务端的异常。之前异常处理是对于每个异步函数添加err处理，这样不仅加大了工作量，还容易遗漏某些异常。幸好Angular6提供了ErrorHandler来处理异常（Ionic4为IonicErrorHandler），默认的ErrorHandler处理异常是将其输出在console上，这显然不能满足需求，所以需要自己实现一个GlobalErrorHandler。",
		  "keywords" : [ "Angular", "Ionic" ],
		  "author": {
		    "@type": "Person",
		    "name": "纪瑞瑶"
		  },
		  "mainEntityOfPage": {
		    "@type": "WebPage",
		    "@id": "https://blog.dteam.top/"
		  },
		  "publisher": {
		    "@type": "Organization",
		    "name": "DTeam 团队日志",
		    "logo": {
		      "@type": "ImageObject",
		      "url": "https://blog.dteam.top/images/favicon.png"
		    }
		  }
		}</script>
</head>


<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title"><a href="https://blog.dteam.top/">DTeam 团队日志</a></h1>
	<div class="site-description"><h2>Doer、Delivery、Dream</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/DTeam-Top" title="Github"><i data-feather="github"></i></a><a href="mailto:jian.hu@shifudao.com" title="Mail"><i data-feather="mail"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">主页</a>
			</li>
			
			<li>
				<a href="/posts.html">所有文章</a>
			</li>
			
			<li>
				<a href="/tools.html">工具推荐</a>
			</li>
			
			<li>
				<a href="/about.html">关于我们</a>
			</li>
			
			<li>
				<a href="/tags.html">标签</a>
			</li>
			
                        <li>
                            <div class="statistics">
                                <span id="busuanzi_container_site_pv">总访问 <span id="busuanzi_value_site_pv"></span> </span>
                                <span id="busuanzi_container_site_uv">总人气 <span id="busuanzi_value_site_uv"></span> </span>
                            </div>
                        </li>
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Angular或Ionic 异常处理：ErrorHandler</h1>
			<div class="meta">纪瑞瑶 Posted at &mdash; Feb 6, 2020
				<span class="meta" id="busuanzi_container_page_pv">阅读 <span id="busuanzi_value_page_pv"></span></span>
			</div>
		</div>

		<div class="share-component" data-sites="qq,weibo,wechat,douban,twitter,facebook"
			data-description="Share.js - 一键分享到微博，QQ空间，腾讯微博，人人，豆瓣"></div>

		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

		<div class="markdown">
			<p>在前端异常处理是非常重要的，包括客户端和服务端的异常。之前异常处理是对于每个异步函数添加err处理，这样不仅加大了工作量，还容易遗漏某些异常。幸好Angular6提供了ErrorHandler来处理异常（Ionic4为IonicErrorHandler），默认的ErrorHandler处理异常是将其输出在console上，这显然不能满足需求，所以需要自己实现一个GlobalErrorHandler。</p>
<h2 id="errorhandler">为什么要用ErrorHandler统一处理异常</h2>
<ul>
<li>提高效率（例如以前对于每个异步函数都需要传入err参数来处理，现在用ErrorHandler统一处理）
之前对于异步异常处理的代码是下面这样的，光看到这么多err都会觉得头晕，更何况上面的逻辑代码，当然，对于多个异步请求这并不是最好的处理方式，这里只讨论异常。</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">         (err<span style="color:#000;font-weight:bold">:</span> any) =&gt; {
                reject(err);
              }
            ), (err<span style="color:#000;font-weight:bold">:</span> any) =&gt; {
              reject(err);
            };
          }, (err<span style="color:#000;font-weight:bold">:</span> any) =&gt; {
            reject(err);
          });
        },
        (err<span style="color:#000;font-weight:bold">:</span> any) =&gt; {
          reject(err);
        }
      );
</code></pre></div><ul>
<li>
<p>可以捕获到不易复现的异常，尤其是客户端不易复现的问题。如果客户出现的问题，本地复现不了，又恰好忘了捕获异常，那将会是非常糟糕的，统一处理可将异常信息输入到日志中，能够快速定位问题。</p>
</li>
<li>
<p>处理不常见的异常或者运行时异常，及时地给用户提示，不至于因为没有捕获异常而导致程序崩溃或者直接将异常暴露给用户，这也是非常糟糕的。</p>
</li>
<li>
<p>对于用户来说，可以显示统一的、友好的异常信息提示，形成独特的系统风格。对于某些异常，甚至可以向用户解释为何会产生这个异常并引导用户行为去消除这个异常。
比如用户在支付时抛出余额不足异常，这个时候应当提示用户的余额不足之外，还应当显示充值入口（如果当前系统支持充值）或者提示用户去哪里充值。</p>
</li>
</ul>
<h2 id="errorhandler-1">用ErrorHandler捕获异常的具体实现</h2>
<h3 id="errorserviceloggingservice">第一步：创建ErrorService和LoggingService用于获取异常信息和记录异常日志</h3>
<p>ErrorService：
获取客户端的异常信息和堆栈、服务端的异常信息和状态码。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">import</span> { Injectable } from <span style="color:#d14">&#39;@angular/core&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { HttpErrorResponse } from <span style="color:#d14">&#39;@angular/common/http&#39;</span>;

<span style="color:#a61717;background-color:#e3d2d2">@</span>Injectable()
<span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">class</span> ErrorService {

    getClientMessage(error<span style="color:#000;font-weight:bold">:</span> <span style="color:#0086b3">Error</span>)<span style="color:#000;font-weight:bold">:</span> string {
        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>navigator.onLine) {
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#39;暂无网络，请检查网络&#39;</span>;
        }
        <span style="color:#000;font-weight:bold">return</span> error.message <span style="color:#000;font-weight:bold">?</span> error.message <span style="color:#000;font-weight:bold">:</span> error.toString();
    }

    getClientStack(error<span style="color:#000;font-weight:bold">:</span> <span style="color:#0086b3">Error</span>)<span style="color:#000;font-weight:bold">:</span> string {
        <span style="color:#000;font-weight:bold">return</span> error.stack;
    }

    getServerMessage(error<span style="color:#000;font-weight:bold">:</span> HttpErrorResponse)<span style="color:#000;font-weight:bold">:</span> string {
        <span style="color:#000;font-weight:bold">return</span> error.message;
    }

    getServerStatus(error<span style="color:#000;font-weight:bold">:</span> HttpErrorResponse)<span style="color:#000;font-weight:bold">:</span> number {
        <span style="color:#000;font-weight:bold">return</span> error.status;
    }
}
</code></pre></div><p>LoggingService:
通过<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Beacon_API">Beacon API</a>向后端发送异常信息，记录异常日志，包括当前登录用户，异常发生时间，异常信息等。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">import</span> { Injectable } from <span style="color:#d14">&#39;@angular/core&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { DatePipe } from <span style="color:#d14">&#39;@angular/common&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { GlobalProvider } from <span style="color:#d14">&#39;../globalprovider&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { environment } from <span style="color:#d14">&#39;@env/environment&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { URL } from <span style="color:#d14">&#39;../url&#39;</span>;

<span style="color:#a61717;background-color:#e3d2d2">@</span>Injectable()
<span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">class</span> LoggingService {

    constructor(<span style="color:#000;font-weight:bold">private</span> global<span style="color:#000;font-weight:bold">:</span> GlobalProvider,
        <span style="color:#000;font-weight:bold">private</span> datePipe<span style="color:#000;font-weight:bold">:</span> DatePipe) { }

    logError(message<span style="color:#000;font-weight:bold">:</span> string, stack<span style="color:#000;font-weight:bold">:</span> string) {
        <span style="color:#000;font-weight:bold">let</span> currentUser <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;notLogin&#39;</span>;
        <span style="color:#000;font-weight:bold">if</span>  (<span style="color:#000;font-weight:bold">this</span>.global.isLogin) {
            currentUser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span>.global.currentUser.username;
        }
        <span style="color:#000;font-weight:bold">const</span> data <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">`</span><span style="color:#d14">{user: </span><span style="color:#d14">${</span>currentUser<span style="color:#d14">}</span><span style="color:#d14">, logtime: </span><span style="color:#d14">${</span><span style="color:#000;font-weight:bold">this</span>.datePipe.transform(<span style="color:#000;font-weight:bold">new</span> <span style="color:#0086b3">Date</span>(), <span style="color:#d14">&#39;yyyy-MM-dd HH:mm:ss&#39;</span>)<span style="color:#d14">}</span><span style="color:#d14">, content: </span><span style="color:#d14">${</span>message<span style="color:#d14">}</span><span style="color:#d14">, stack: </span><span style="color:#d14">${</span>stack<span style="color:#d14">}</span><span style="color:#d14">}</span><span style="color:#d14">`</span>;
        <span style="color:#000;font-weight:bold">if</span> (navigator.sendBeacon) {
            navigator.sendBeacon(environment.SERVER_URL <span style="color:#000;font-weight:bold">+</span> URL.log, data);
        } <span style="color:#000;font-weight:bold">else</span> {
            <span style="color:#998;font-style:italic">// 不支持Beacon
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">const</span> xhr <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLHttpRequest();
            xhr.open(<span style="color:#d14">&#39;post&#39;</span>, environment.SERVER_URL <span style="color:#000;font-weight:bold">+</span> URL.log, <span style="color:#000;font-weight:bold">false</span>);
            xhr.send(data);
        }
    }
}
</code></pre></div><h3 id="globalerrorhandler">第二步：创建GlobalErrorHandler</h3>
<ol>
<li>创建global-error-handler.ts</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">
<span style="color:#000;font-weight:bold">import</span> { ErrorHandler, Injectable, Injector } from <span style="color:#d14">&#39;@angular/core&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { HttpErrorResponse } from <span style="color:#d14">&#39;@angular/common/http&#39;</span>;

<span style="color:#a61717;background-color:#e3d2d2">@</span>Injectable()
<span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">class</span> GlobalErrorHandler <span style="color:#000;font-weight:bold">implements</span> ErrorHandler {

    constructor(<span style="color:#000;font-weight:bold">private</span> injector<span style="color:#000;font-weight:bold">:</span> Injector) { }

    handleError(error<span style="color:#000;font-weight:bold">:</span> <span style="color:#0086b3">Error</span> <span style="color:#000;font-weight:bold">|</span> HttpErrorResponse) {
    }
}
</code></pre></div><ol start="2">
<li>在app.module.ts中添加</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">providers<span style="color:#000;font-weight:bold">:</span>  [
...
 { provide<span style="color:#000;font-weight:bold">:</span> ErrorHandler, useClass<span style="color:#000;font-weight:bold">:</span> GlobalErrorHandler},
...
]
</code></pre></div><ol start="3">
<li>添加异常处理逻辑</li>
</ol>
<ul>
<li>当前使用的框架是Ant Design，所以用户提示就用了NzMessageService。</li>
<li>当程序中出现异常时，会自动调用handleError钩子，可判断是客户端还是来自服务端的异常。</li>
<li>在实际项目中，可能需要提供显示异常信息的Service来满足不同异常信息的显示。</li>
<li>对于异常日志的记录，可根据异常的内容来筛选，不需要每个异常都记录。</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">import</span> { ErrorHandler, Injectable, Injector } from <span style="color:#d14">&#39;@angular/core&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { HttpErrorResponse } from <span style="color:#d14">&#39;@angular/common/http&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { LoggingService } from <span style="color:#d14">&#39;./services/logging.service&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { ErrorService } from <span style="color:#d14">&#39;./services/error.service&#39;</span>;
<span style="color:#000;font-weight:bold">import</span> { NzMessageService } from <span style="color:#d14">&#39;ng-zorro-antd&#39;</span>;

<span style="color:#a61717;background-color:#e3d2d2">@</span>Injectable()
<span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">class</span> GlobalErrorHandler <span style="color:#000;font-weight:bold">implements</span> ErrorHandler {

    constructor(<span style="color:#000;font-weight:bold">private</span> injector<span style="color:#000;font-weight:bold">:</span> Injector) { }

    handleError(error<span style="color:#000;font-weight:bold">:</span> <span style="color:#0086b3">Error</span> <span style="color:#000;font-weight:bold">|</span> HttpErrorResponse) {

        <span style="color:#000;font-weight:bold">const</span> errorService <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span>.injector.get(ErrorService);
        <span style="color:#000;font-weight:bold">const</span> logger <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span>.injector.get(LoggingService);
        <span style="color:#000;font-weight:bold">const</span> msg <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span>.injector.get(NzMessageService);

        <span style="color:#000;font-weight:bold">let</span> message;
        <span style="color:#000;font-weight:bold">let</span> status;
        <span style="color:#000;font-weight:bold">let</span> stackTrace;

        <span style="color:#000;font-weight:bold">if</span> (error <span style="color:#000;font-weight:bold">instanceof</span> HttpErrorResponse) {
            message <span style="color:#000;font-weight:bold">=</span> errorService.getServerMessage(error);
            status <span style="color:#000;font-weight:bold">=</span> errorService.getServerStatus(error);
           <span style="color:#998;font-style:italic">// 提示异常信息
</span><span style="color:#998;font-style:italic"></span>            msg.error(message);
        } <span style="color:#000;font-weight:bold">else</span> {
            message <span style="color:#000;font-weight:bold">=</span> errorService.getClientMessage(error);
            stackTrace <span style="color:#000;font-weight:bold">=</span> errorService.getClientStack(error);
           <span style="color:#998;font-style:italic">// 提示异常信息
</span><span style="color:#998;font-style:italic"></span>            msg.error(message);
        }
        <span style="color:#998;font-style:italic">// 记录日常日志
</span><span style="color:#998;font-style:italic"></span>        logger.logError(message, stackTrace);
    }
}
</code></pre></div><blockquote>
<p>注：很多人之前在Interceptor中处理异常，Interceptor中只能处理HttpErrorResponse类型的error，如果这里处理了，那么ErrorHandler将捕获不到。所以在Interceptor中，遇到HttpErrorResponse的error需要抛出。</p>
</blockquote>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">catchError((error<span style="color:#000;font-weight:bold">:</span> HttpErrorResponse) =&gt; {
        <span style="color:#000;font-weight:bold">if</span> (error.status <span style="color:#000;font-weight:bold">===</span> <span style="color:#099">401</span>) {
          <span style="color:#998;font-style:italic">// 跳到登录页或者刷新token
</span><span style="color:#998;font-style:italic"></span>        } <span style="color:#000;font-weight:bold">else</span> {
          <span style="color:#000;font-weight:bold">return</span> throwError(error);
        }
 })
</code></pre></div><p>对于一个项目，有一个良好的异常处理机制是非常重要的，ErrorHandler解决了很多之前异常处理方式的痛点，对于使用Angular/Ionic的小伙伴来说是个不错的选择。</p>

		</div>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="flat">
					
					<li><a href="/tags/angular.html">Angular</a></li>
					
					<li><a href="/tags/ionic.html">Ionic</a></li>
					
				</ul>
			</nav>
			
			
		</div></div>
	<div class="footer wrapper">
    <p><img src="/images/mingpian.png"></p>
    <nav class="nav">
        <div><a href="http://www.beian.miit.gov.cn">陕ICP备18009003号-3</a> | 
            <a href="mailto:jian.hu@shifudao.com">联系我们</a> | <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
        </div>
    </nav>
</div><script>feather.replace();
       (function () {
               if (window.location.href.endsWith('about.html') ||
                       window.location.href.endsWith('posts.html') ||
                       window.location.href.endsWith('localhost:1313/')) {
                       return false;
               };

               var httpRequest = new XMLHttpRequest();
               if (!httpRequest) {
                       alert('Giving up :( Cannot create an XMLHTTP instance');
                       return false;
               }

               httpRequest.onreadystatechange = alertContents;
               httpRequest.open('GET', 'https://recommend.blog.dteam.top/');
               httpRequest.send();

               function alertContents() {
                       if (httpRequest.readyState === XMLHttpRequest.DONE) {
                               if (httpRequest.status === 200) {
                                       var div = document.getElementsByTagName("div")[0];
                                       div.innerHTML += '<hr><h3 class="page-title">其他文章</h3>' + httpRequest.responseText.replace('posts',
                                               'post-header');
                               }
                       }
               }
       })();
</script><script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7ee18e8ed5acdd8c702a82c2d1aae74e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</body>

</html>